<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>瘦高等腰三角形 — 中线为轴的 3D 对称旋转 + 腰中点拖动无跳动</title>
<style>
  body {
    background: #f4f6f8;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    display:flex;
    align-items:center;
    justify-content:center;
    height:100vh;
    margin:0;
  }
  .stage {
    position: relative;
    width:560px;
    height:420px;
    perspective: 1200px;
    border-radius:12px;
    background: white;
    box-shadow: 0 8px 30px rgba(20,30,40,0.12);
    padding:10px;
    box-sizing:border-box;
    user-select:none;
  }
  svg {
    width:100%;
    height:100%;
    overflow:visible;
    display:block;
    transform-style: preserve-3d;
  }
  .triangle-group {
    transform-style: preserve-3d;
    transition: transform 900ms cubic-bezier(.2,.9,.2,1);
    transform-origin: 0 0;
    backface-visibility: hidden;
  }
  .median-line {
    cursor: pointer;
  }
  .median-line:hover {
    stroke-opacity:0.9;
  }
  .mark {
    fill:#ffffff;
    stroke:#0b66ff;
    stroke-width:2;
    r:10;
    cursor: pointer;
    transition: fill 0.3s;
  }
  .mark:hover {
    fill:#0b66ff;
  }
  .label {
    font-size:14px;
    fill:#0b66ff;
    font-weight:600;
    user-select:none;
    pointer-events:none;
  }
  .center-dot {
    fill:#222;
    r:3.5;
  }
  .tri-shadow {
    fill: rgba(0,0,0,0.06);
    filter: blur(1.5px);
  }
  .hint {
    font-size:12px;
    fill:#666;
  }
  .controls {
    position: absolute;
    top: 12px;
    right: 14px;
    background: #fff;
    padding: 6px 12px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    font-size: 15px;
    user-select: none;
    cursor: pointer;
    pointer-events: auto;
    z-index: 10;
  }
  .controls input[type="checkbox"] {
    width: 18px;
    height: 18px;
    vertical-align: middle;
    margin-right: 6px;
    cursor: pointer;
  }
</style>
</head>
<body>
  <div class="stage" id="stage">
    <div class="controls">
      <label>
        <input type="checkbox" id="connectMidpoints"> 显示腰中点到对边顶点的连线
      </label>
    </div>

    <svg id="svg" viewBox="0 0 500 360" xmlns="http://www.w3.org/2000/svg">
      <g id="triGroup" class="triangle-group">
        <polygon id="triShadow" class="tri-shadow" points="" />
        <polygon id="triangle" points="" fill="#0b66ff" fill-opacity="0.95" stroke="#063f9a" stroke-width="2"/>
        <circle id="A" class="mark" cx="0" cy="0" r="10" />
        <text id="A_label" class="label" x="0" y="0">A</text>
        <circle id="B" class="mark" cx="0" cy="0" r="10" />
        <!-- B_label 已去掉 -->
        <circle id="M" class="center-dot" cx="0" cy="0"></circle>
        <line id="median" class="median-line" x1="0" y1="0" x2="0" y2="0"
              stroke="#ff6b00" stroke-width="3" stroke-dasharray="8 6" stroke-linecap="round" stroke-opacity="0.85"/>
      </g>
    </svg>
  </div>

<script>
(function(){
  // 三角形三个顶点固定
  const apex = { x: 250, y: 50 };
  const baseLeft = { x: 120, y: 300 };
  const baseRight = { x: 380, y: 300 };

  // 当前腰上点的位置，初始化为中点
  let A = { x: (apex.x + baseLeft.x) / 2, y: (apex.y + baseLeft.y) / 2 };
  let B = { x: (apex.x + baseRight.x) / 2, y: (apex.y + baseRight.y) / 2 };
  const M = { x: (baseLeft.x + baseRight.x) / 2, y: (baseLeft.y + baseRight.y) / 2 };

  const triangle = document.getElementById('triangle');
  const triShadow = document.getElementById('triShadow');
  const triGroup = document.getElementById('triGroup');
  const median = document.getElementById('median');
  const circleA = document.getElementById('A');
  const labelA = document.getElementById('A_label');
  const circleB = document.getElementById('B');
  const circleM = document.getElementById('M');

  // 用于连接线
  let lineAtoBaseRight = null;
  let lineBtoBaseLeft = null;

  function pointsToString(...pts){
    return pts.map(p => `${p.x},${p.y}`).join(' ');
  }

  // 设置旋转轴和中心，基于apex和M
  const dx = (M.x - apex.x);
  const dy = (M.y - apex.y);
  const len = Math.hypot(dx, dy) || 1;
  const axis = { x: dx/len, y: dy/len, z: 0 };
  const origin = { x: (apex.x + M.x)/2, y: (apex.y + M.y)/2 };

  triGroup.style.transformOrigin = `${origin.x}px ${origin.y}px`;
  triGroup.style.webkitTransformOrigin = `${origin.x}px ${origin.y}px`;

  const rotateAngle = 180;
  const axisStr = `${axis.x.toFixed(6)}, ${axis.y.toFixed(6)}, ${axis.z.toFixed(6)}`;
  let rotated = false;

  function applyRotation(){
    if(!rotated){
      triGroup.style.transform = `rotate3d(${axisStr}, ${rotateAngle}deg)`;
    } else {
      triGroup.style.transform = `none`;
    }
  }

  // 更新所有元素位置
  function updateGraphics(){
    // 三角形点：顶点+底边
    triangle.setAttribute('points', pointsToString(apex, baseLeft, baseRight));
    const shadowOffset = { x: 6, y: 10 };
    triShadow.setAttribute('points', pointsToString(
      {x: apex.x + shadowOffset.x, y: apex.y + shadowOffset.y},
      {x: baseLeft.x + shadowOffset.x, y: baseLeft.y + shadowOffset.y},
      {x: baseRight.x + shadowOffset.x, y: baseRight.y + shadowOffset.y}
    ));

    // A点位置及标签
    circleA.setAttribute('cx', A.x);
    circleA.setAttribute('cy', A.y);
    labelA.setAttribute('x', A.x + 12);
    labelA.setAttribute('y', A.y + 6);

    // B点位置
    circleB.setAttribute('cx', B.x);
    circleB.setAttribute('cy', B.y);

    // 底边中点
    circleM.setAttribute('cx', M.x);
    circleM.setAttribute('cy', M.y);

    // 底边中线虚线
    median.setAttribute('x1', apex.x);
    median.setAttribute('y1', apex.y);
    median.setAttribute('x2', M.x);
    median.setAttribute('y2', M.y);

    // 连接线控制
    const checkbox = document.getElementById('connectMidpoints');
    if(checkbox.checked){
      if(!lineAtoBaseRight){
        lineAtoBaseRight = document.createElementNS('http://www.w3.org/2000/svg','line');
        lineAtoBaseRight.setAttribute('stroke','#d32f2f');
        lineAtoBaseRight.setAttribute('stroke-width','2');
        triGroup.appendChild(lineAtoBaseRight);
      }
      lineAtoBaseRight.setAttribute('x1', A.x);
      lineAtoBaseRight.setAttribute('y1', A.y);
      lineAtoBaseRight.setAttribute('x2', baseRight.x);
      lineAtoBaseRight.setAttribute('y2', baseRight.y);

      if(!lineBtoBaseLeft){
        lineBtoBaseLeft = document.createElementNS('http://www.w3.org/2000/svg','line');
        lineBtoBaseLeft.setAttribute('stroke','#d32f2f');
        lineBtoBaseLeft.setAttribute('stroke-width','2');
        triGroup.appendChild(lineBtoBaseLeft);
      }
      lineBtoBaseLeft.setAttribute('x1', B.x);
      lineBtoBaseLeft.setAttribute('y1', B.y);
      lineBtoBaseLeft.setAttribute('x2', baseLeft.x);
      lineBtoBaseLeft.setAttribute('y2', baseLeft.y);
    } else {
      if(lineAtoBaseRight){
        triGroup.removeChild(lineAtoBaseRight);
        lineAtoBaseRight = null;
      }
      if(lineBtoBaseLeft){
        triGroup.removeChild(lineBtoBaseLeft);
        lineBtoBaseLeft = null;
      }
    }
  }

  updateGraphics();

  // 点击虚线旋转切换
  const hit = document.createElementNS('http://www.w3.org/2000/svg','line');
  hit.setAttribute('x1', apex.x);
  hit.setAttribute('y1', apex.y);
  hit.setAttribute('x2', M.x);
  hit.setAttribute('y2', M.y);
  hit.setAttribute('stroke', 'transparent');
  hit.setAttribute('stroke-width', '18');
  hit.setAttribute('pointer-events', 'stroke');
  triGroup.appendChild(hit);

  function onClickMedian(){
    rotated = !rotated;
    applyRotation();
  }
  hit.addEventListener('click', onClickMedian);
  median.addEventListener('click', onClickMedian);

  document.getElementById('stage').addEventListener('click', function(ev){
    if(ev.target === median || ev.target === hit) return;
    if(rotated){
      rotated = false;
      applyRotation();
    }
  });

  document.getElementById('svg').addEventListener('mousedown', e => e.preventDefault());

  // 复选框控制连接线显示
  const checkbox = document.getElementById('connectMidpoints');
  checkbox.addEventListener('change', updateGraphics);

  // 计算点p到线段pq的投影点坐标（限制在线段上）
  function projectPointOnSegment(p, q1, q2){
    const vx = q2.x - q1.x;
    const vy = q2.y - q1.y;
    const wx = p.x - q1.x;
    const wy = p.y - q1.y;
    const c1 = vx*wx + vy*wy;
    const c2 = vx*vx + vy*vy;
    let t = c1 / c2;
    if(t < 0) t = 0;
    else if(t > 1) t = 1;
    return { x: q1.x + vx*t, y: q1.y + vy*t };
  }

  // 修正拖拽，防止点跳动
  let dragging = null; // 'A' or 'B' or null
  let dragOffset = { x: 0, y: 0 };

  circleA.addEventListener('mousedown', e => {
    e.preventDefault();
    dragging = 'A';
    const svg = document.getElementById('svg');
    const pt = svg.createSVGPoint();
    pt.x = e.clientX;
    pt.y = e.clientY;
    const cursorpt = pt.matrixTransform(svg.getScreenCTM().inverse());
    dragOffset.x = cursorpt.x - A.x;
    dragOffset.y = cursorpt.y - A.y;
  });

  circleB.addEventListener('mousedown', e => {
    e.preventDefault();
    dragging = 'B';
    const svg = document.getElementById('svg');
    const pt = svg.createSVGPoint();
    pt.x = e.clientX;
    pt.y = e.clientY;
    const cursorpt = pt.matrixTransform(svg.getScreenCTM().inverse());
    dragOffset.x = cursorpt.x - B.x;
    dragOffset.y = cursorpt.y - B.y;
  });

  window.addEventListener('mouseup', e => {
    dragging = null;
  });

  window.addEventListener('mousemove', e => {
    if(!dragging) return;

    const svg = document.getElementById('svg');
    const pt = svg.createSVGPoint();
    pt.x = e.clientX;
    pt.y = e.clientY;
    let cursorpt = pt.matrixTransform(svg.getScreenCTM().inverse());

    // 减去偏移，防止拖拽起点跳动
    cursorpt = {
      x: cursorpt.x - dragOffset.x,
      y: cursorpt.y - dragOffset.y,
    };

    if(dragging === 'A'){
      A = projectPointOnSegment(cursorpt, apex, baseLeft);
    } else if(dragging === 'B'){
      B = projectPointOnSegment(cursorpt, apex, baseRight);
    }
    updateGraphics();
  });

})();
</script>
</body>
</html>

